<!DOCTYPE html>
<html>



<body>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<div id="canvDiv" class="unselectable" style="position:absolute; left: 0, top: 0;">
	<canvas id="canv0" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
	<canvas id="canv1" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
	<canvas id="canv2" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>
	<canvas id="canv3" style="position: absolute; left: 0; top: 0; z-index: 3;"></canvas>
	<canvas id="canv4" style="position: absolute; left: 0; top: 0; z-index: 4;"></canvas>
	<canvas id="canv5" style="position: absolute; left: 0; top: 0; z-index: 5;"></canvas>
	<canvas id="canv6" style="position: absolute; left: 0; top: 0; z-index: 6;"></canvas>
	<canvas id="canv7" oncontextmenu="return false;" style="position: absolute; left: 0; top: 0; z-index: 7;"></canvas>	
</div>

<script>
	//loading bar colors: defined here because the color image isn't loaded yet
	const color_load_back = 'black';
	const color_load_base = 'gray';
	const color_load_bar = 'RGB(25,124,247)'
	
	//color indexes
	var COLOR_BACK= '';
	var COLOR_PLAYER_TOP= '';
	var COLOR_PLAYER_SIDEA= '';
	var COLOR_PLAYER_SIDEB= '';
	var COLOR_BUILDING_SIDEA= '';
	var COLOR_BUILDING_SIDEB= '';
	var COLOR_BUTTON_HOVER= '';
	var COLOR_BUTTON_FLASH= '';
	var COLOR_TARGET= '';
	var COLOR_TARGET_LINES= '';
	var COLOR_LEVEL_TEXT= '';
	
	//enums
	const BACK = 0;
	const BELOW_ALL = 1;
	const BUILDINGS = 2;
	const BELOW_BASE = 3;
	const BASE = 4;
	const BUT_SEL_CANV = 5;
	const ABOVE_BASE = 6;
	const BUT_CANV = 7;

	const CLICK_START = 0;
	const CLICK_MOVE = 1;
	const CLICK_END = 2;

	const SELECT_BUT = -1;
	const SELECT_ZOOM = 2; 
	const SELECT_MOVE = 3;

	const ACTIVE = 4;
	const IDLE = 5;
	const BURNING = 6
	const FALLING = 7;
	const DEAD = 8;
	const WINNING = 9;
	const FINISHED = 10;
	
	const Pi_4 = Math.PI/4;
	const Pi3_4 = 3 * Pi_4;
	const Pi5_4 = 5 * Pi_4;
	const Pi7_4 = 7 * Pi_4;
	const Pi_2 = Math.PI/2;
	const Pi3_2 = Pi_2 * 3;

	var colorsImg, butImg, squareImg, playerImg, numbersImg;
	var butSrcs =  [
		['blocks/pics/colors.svg', "colorsImg"],
		['blocks/pics/buttons.svg', "butImg"], 
		['blocks/pics/squares.svg', "squareImg"],
		['blocks/pics/player.svg', "playerImg"],
		['blocks/pics/numbers.svg', "numbersImg"]
	];
	

	
	//define script files
	var scripts = [
		"https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js",
		'blocks/code/helpers.js',
		'blocks/code/settings.js',
		'blocks/code/objects.js',
		'blocks/code/squares.js',
		'blocks/code/levels.js',
		'blocks/code/buttons.js', 
		'blocks/code/inputs.js',
		'blocks/code/animator.js'
	];
	
	//load all scripts and images
	var imageCnt = butSrcs.length;
	var scriptCnt = scripts.length;
	var loaded = 0;
	var toLoad = imageCnt + scriptCnt;
	var canv = [];
	var cx = [];
	
	
	//used to force image/code reload instead of what's cached
	//todo: might be a better way of doing this that doesn't swamp the cache
	function rando()
	{
		return "?" + new Date().getTime();
	}

	
	function loadScripts(ind)
	{
		if(ind < scriptCnt)
		{
			var script = document.createElement('script');
			script.onload = function(){loadScripts(ind + 1);};
			script.src = scripts[ind] + rando();
			document.body.appendChild(script);
		}
		if(ind > 0)
		{
			++loaded;
			console.log(loaded);
			if(ind == 1)
			{
				WebFont.load(
				{
					google: {
						families: ['Roboto:900']
					},
					/* loading: function() {
						console.log("Fonts are being loaded");
					},
					active: function() {
						console.log("Fonts have been rendered")
					} */
				});
			}
		}
	}
	
	function loadImages(ind)
	{
		
		if(ind < imageCnt)
		{
			for ( var v in window ) 
			{
				if(v == butSrcs[ind][1]) 
				{
					window[butSrcs[ind][1]] = document.createElement("img");
					window[butSrcs[ind][1]].onload = function(){loadImages(ind + 1)};
					window[butSrcs[ind][1]].src = butSrcs[ind][0] + rando();
					break;
				}
			}
		}
		if(ind > 0) ++loaded;
	}

			

	//main entry point
	function startLoading() 
	{
		loadImages(0);
		loadScripts(0);
		
		setTimeout(function () 
		{
			//remove dead space
			var mainDiv = document.getElementById("canvDiv");
			mainDiv.style.left = 0 + 'px';
			mainDiv.style.top = 0 + 'px';
			
			//create canvas array
			for(var i = 0; i <= BUT_CANV; i += 1)
			{
				var newCanv = document.getElementById("canv" + i);
				canv.push(newCanv);
				cx.push(newCanv.getContext("2d"));
			}
			
			//start the loading animation
			animateLoading();
			
		}, 300);
	}
	
	//draws a loading status bar
	function animateLoading(w, h, r_w, r_h)
	{
		var w = (window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth);
		var h = (window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight);
		if(canv[0].width != w) canv[0].width = w;
		if(canv[0].height != h) canv[0].height = h;
		
		var r_h = Math.min(200, h - 2 * 50);
		var r_w = Math.min(800, w - 2 * 50);
		
		//draw loading bar
		cx[BACK].fillStyle = color_load_back;
		cx[BACK].fillRect(0, 0, w, h);
		cx[BACK].fillStyle = color_load_base;
		cx[BACK].fillRect((w - r_w)/2, (h - r_h)/2, r_w, r_h);
		cx[BACK].fillStyle = color_load_bar;
		cx[BACK].fillRect((w - r_w)/2, (h - r_h)/2, r_w * loaded/toLoad, r_h);
		
		//next loop
		if(loaded < toLoad)
		{
			requestAnimationFrame(animateLoading);
		}
		else
		{
			//finished loading: start the game
			startGame();
		}
	}
	
	function setColors()
	{
		var buff = .2;
		var full = colorsImg.height;
		var offset = full * (1 - buff);
		
		for(var i = 0; i <= 10; i += 1)
		{
			cx[BACK].drawImage(colorsImg, full * i + offset, offset, offset, offset, 0,0,60,60);
			var imgData = cx[BACK].getImageData(5,5,20,20);
			var rgb = 'rgb(';
			for(j = 0; j < 3; j += 1)
			{
				rgb += imgData.data[j];
				if(j < 2) rgb += ',';
				else rgb += ')';
			}
			console.log(j);
			switch(i)
			{
				case 0: COLOR_BACK = rgb; break;
				case 1: COLOR_PLAYER_TOP = rgb; break;
				case 2: COLOR_PLAYER_SIDEA = rgb; break;
				case 3: COLOR_PLAYER_SIDEB = rgb; break;
				case 4: COLOR_BUILDING_SIDEA = rgb; break;
				case 5: COLOR_BUILDING_SIDEB = rgb; break;
				case 6: COLOR_BUTTON_HOVER = rgb; break;
				case 7: COLOR_BUTTON_FLASH = rgb; break;
				case 8: COLOR_TARGET = rgb; break;
				case 9: COLOR_TARGET_LINES = rgb; break; 
				case 10: COLOR_LEVEL_TEXT = rgb; break;
			}
				
		}
	}
			
 
	
	//gets the game going once everything's loaded
	function startGame()
	{
		console.log('starting');
		
		player.img = playerImg;
		
		//find the placement of the zoom buttons
		for(var x = 0; x < 2; x+=1)
		{
			for(var i = 0; i < butts[x].length; i+=1)
			{
				switch(butts[x][i])
				{
					case scrnButNotFull:
						SELECT_ZOOM_COL[x] = i;
						break;
					case movesBut:
						MOVES_DISPLAY = i;
						break;
					case undoBut:
						UNDO_IND = i;
						break;
					case restartBut:
						RESTART_IND = i;
						break;
				}
			}
		}
		

		//set up input listeners
		//touch
		document.addEventListener("touchstart", startClick);
		document.addEventListener("touchend", endClick);
		document.addEventListener("touchmove", moveClick, {passive: false});
		
		//mouse
		document.addEventListener("mousedown", startClick);
		document.addEventListener("mousemove", moveClick);
		document.addEventListener("mouseup", endClick);
		
		//keys
		document.addEventListener('keydown', keyEvent);

		//screen rotate
		window.addEventListener("orientationchange", screenFlip);
		
		setColors();
		
		
		//load the first level
		level.index = firstLevel - 1;
		if(loadLast)
		{
			level.index = GAME_LEVELS.length - 2;
		}
		nextLevel();
		
		//start the game loop
		animate();
		
	}
	
	//initiate loading/starting the game
	startLoading();
	
	
</script>



</body>

</html> 